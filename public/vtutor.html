<!DOCTYPE html>
<html>
<head>
  <title>VTutor</title>
  <style>
    body {
      margin: 0;
      background: #111;
    }
    canvas {
      display: block;
      width: 100%;
      height: 100vh;
      background-color: #222;
    }
  </style>
</head>
<body>
  <canvas id="avatarCanvas"></canvas>
  <script>
    const canvas = document.getElementById('avatarCanvas')
    const ctx = canvas.getContext('2d')
    canvas.width = window.innerWidth
    canvas.height = window.innerHeight

    const avatar = new Image()
    const mouth = new Image()
    avatar.src = '/avatar-base.png'
    mouth.src = '/mouth-open.png'

    let mouthScale = 1
    let emotion = 'neutral'

    function drawAvatar({ mouthScale = 1, emotion = 'neutral' } = {}) {
      const cx = canvas.width / 2
      const cy = canvas.height / 2

      ctx.clearRect(0, 0, canvas.width, canvas.height)

      // Draw base avatar image
      if (avatar.complete) {
        ctx.drawImage(avatar, cx - 150, cy - 200, 300, 400)
      }

      // Draw mouth (scaled)
      if (mouth.complete) {
        const mouthW = 50
        const mouthH = 20 * mouthScale
        ctx.drawImage(mouth, cx - mouthW / 2, cy + 20 - mouthH / 2, mouthW, mouthH)
      }

      // Draw expressions (eyebrows)
      ctx.strokeStyle = '#000'
      ctx.lineWidth = 4
      ctx.beginPath()

      if (emotion === 'angry') {
        ctx.moveTo(cx - 60, cy - 80)
        ctx.lineTo(cx - 40, cy - 90)
        ctx.moveTo(cx + 40, cy - 90)
        ctx.lineTo(cx + 60, cy - 80)
      } else if (emotion === 'happy') {
        ctx.moveTo(cx - 60, cy - 80)
        ctx.lineTo(cx - 40, cy - 70)
        ctx.moveTo(cx + 40, cy - 70)
        ctx.lineTo(cx + 60, cy - 80)
      } else {
        ctx.moveTo(cx - 60, cy - 80)
        ctx.lineTo(cx - 40, cy - 80)
        ctx.moveTo(cx + 40, cy - 80)
        ctx.lineTo(cx + 60, cy - 80)
      }

      ctx.stroke()
    }

    avatar.onload = drawAvatar
    mouth.onload = drawAvatar

    window.addEventListener('message', async (e) => {
      if (e.data.action === 'speak') {
        const { text, audioUrl } = e.data
        console.log('VTutor speaking:', text)

        const audio = new Audio(audioUrl)
        const context = new AudioContext()
        const source = context.createMediaElementSource(audio)
        const analyser = context.createAnalyser()
        const dataArray = new Uint8Array(analyser.frequencyBinCount)

        source.connect(analyser)
        analyser.connect(context.destination)

        await audio.play()

        function animate() {
          requestAnimationFrame(animate)
          analyser.getByteTimeDomainData(dataArray)

          let sum = 0
          for (let i = 0; i < dataArray.length; i++) {
            const v = dataArray[i] - 128
            sum += v * v
          }

          const volume = Math.sqrt(sum / dataArray.length)
          const scale = Math.min(Math.max(volume / 10, 0.3), 2.0)

          // Basic emotion logic based on volume
          if (volume > 15) emotion = 'angry'
          else if (volume > 7) emotion = 'happy'
          else emotion = 'neutral'

          drawAvatar({ mouthScale: scale, emotion })
        }

        animate()
      }
    })
  </script>
</body>
</html>
